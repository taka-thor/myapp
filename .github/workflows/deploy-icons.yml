name: Deploy Icons to S3

on:
  workflow_dispatch:
  push:
    branches:
      - "*"
    paths:
      - "app/icons_src/**"
      - ".github/workflows/deploy-icons.yml"

jobs:
  build-and-upload-icons:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Install ImageMagick (for MiniMagick)
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Build icons with MiniMagick
        env:
          RAILS_ENV: production
          SECRET_KEY_BASE: dummy
        run: |
          bin/rails icons:build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check AWS CLI
        run: |
          aws --version

      - name: Upload icons to S3
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_ICON_BUCKET_NAME }}
        run: |
          aws s3 sync tmp/icons_build "s3://$S3_BUCKET_NAME/icons" \
            --delete \
            --cache-control "public, max-age=31536000"

      - name: Generate manifest.json
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_ICON_BUCKET_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          ruby - <<'RUBY'
          require "json"
          require "time"

          bucket = ENV.fetch("S3_BUCKET_NAME")
          region = ENV.fetch("AWS_REGION")

          base_dir = "tmp/icons_build"
          files = Dir.glob("#{base_dir}/**/*.{png,jpg,jpeg,webp,gif,svg}", File::FNM_CASEFOLD).sort


          icons = files.map do |path|
            rel = path.sub("#{base_dir}/", "")
            key = "icons/#{rel}" # 同一バケット内のキー

            {
              "key" => key,
              "filename" => File.basename(rel),
              "path" => rel,
              "url" => "https://#{bucket}.s3.#{region}.amazonaws.com/#{key}",
              "size" => File.size(path)
            }
          end

          manifest = {
            "generated_at" => Time.now.utc.iso8601,
            "count" => icons.length,
            "icons" => icons
          }

          File.write("manifest.json", JSON.pretty_generate(manifest) + "\n")
          puts "Wrote manifest.json (#{icons.length} icons)"
          RUBY

      - name: Upload manifest.json to S3 (assets folder)
        env:
          S3_BUCKET_NAME: ${{ secrets.S3_ICON_BUCKET_NAME }}
        run: |
          aws s3 cp manifest.json "s3://$S3_BUCKET_NAME/assets/icons_manifest.json" \
            --content-type "application/json" \
            --cache-control "no-cache"
