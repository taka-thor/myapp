services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    restart: unless-stopped

  assets-export:
    image: ghcr.io/taka-thor/myapp:latest
    pull_policy: always
    command: >
      bash -lc '
        set -e
        if ! mountpoint -q /host-assets; then
          echo "ERROR: /host-assets not mounted"; exit 1
        fi
        rsync -a --delete /app/public/assets/ /host-assets/
        rsync -a --delete /app/public/manifest*.json /host-assets/ 2>/dev/null || true
        chown -R 33:33 /host-assets
      '
    volumes:
      - /var/www/myapp/current/public/assets:/host-assets
    restart: "no"

  web:
    image: ghcr.io/taka-thor/myapp:latest
    pull_policy: always
    command: bash -lc "rm -f tmp/pids/server.pid && bin/rails s -b 0.0.0.0 -p 3000"
    env_file:
      - /var/www/myapp/shared/.env.production
    environment:
      RAILS_ENV: production
      TZ: Asia/Tokyo
      RAILS_SERVE_STATIC_FILES: "true"
      RAILS_LOG_TO_STDOUT: "true"
      REDIS_URL: redis://redis:6379/1
    ports:
      - "127.0.0.1:3000:3000"
    depends_on:
      redis:
        condition: service_started
      assets-export:
        condition: service_completed_successfully
    restart: unless-stopped
